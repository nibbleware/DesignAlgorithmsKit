name: Documentation

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build and Deploy Documentation
    runs-on: macos-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: "5.9"
      
      - name: Show Swift version
        run: swift --version
      
      - name: Build package
        run: swift build
      
      - name: Generate DocC documentation
        run: |
          # Create Xcode project for DocC generation
          swift package generate-xcodeproj 2>/dev/null || true
          
          # Generate documentation using xcodebuild
          if [ -f "DesignAlgorithmsKit.xcodeproj/project.pbxproj" ]; then
            xcodebuild docbuild \
              -project DesignAlgorithmsKit.xcodeproj \
              -scheme DesignAlgorithmsKit \
              -destination 'platform=macOS' \
              -derivedDataPath .build
            
            # Find documentation archive
            DOCS_ARCHIVE=$(find .build -name "*.doccarchive" -type d | head -1)
            if [ -z "$DOCS_ARCHIVE" ]; then
              echo "Error: Documentation archive not found"
              exit 1
            fi
            echo "archive_path=$DOCS_ARCHIVE" >> $GITHUB_OUTPUT
          else
            # Fallback: Use swift-docc-plugin if available
            echo "Xcode project not found, trying alternative method"
            swift package resolve
            # Create a simple documentation structure
            mkdir -p Documentation
            echo "Documentation will be generated manually" > Documentation/README.md
            echo "archive_path=./Documentation" >> $GITHUB_OUTPUT
          fi
        id: generate-docs
        continue-on-error: true
      
      - name: Setup Pages
        uses: actions/configure-pages@v3
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: ${{ steps.generate-docs.outputs.archive_path || './Documentation' }}
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
